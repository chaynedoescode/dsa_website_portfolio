<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Station Map</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling */
            height: 100%; /* Ensure full-height layout */
        }
        #top-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 70%;
            position: relative;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        #bottom-container {
            display: flex;
            height: 30%;
        }
        #form-container {
            flex: 1;
            padding: 10px;
            border-right: 1px solid #ccc;
        }
        #form-container input, #form-container button {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
        }
        #output-container {
            flex: 2;
            padding: 10px;
            border: 1px solid #ccc;
            overflow-y: auto;
        }
        #output-container p {
            margin: 0;
            padding: 2px;
        }
    </style>
</head>
<body>
    <main style="display: flex; flex-direction: column; height: 100vh;">
        <!-- Top container for the map -->
        <div id="top-container">
            <iframe id="rail-map" src="{{ url_for('static', filename='rail_map_with_interchanges.html') }}"></iframe>
        </div>

        <!-- Bottom container -->
        <div id="bottom-container">
            <!-- Form container -->
            <div id="form-container">
                <input type="text" id="from-station" placeholder="From Station" readonly>
                <input type="text" id="to-station" placeholder="To Station" readonly>
                <button id="submit-button">Submit</button>
                <button id="reset-button">Reset</button>
            </div>

            <!-- Output container -->
            <div id="output-container">
                <p>Click on the map to select a station.</p>
            </div>
        </div>
    </main>

    <script>
        const lrt2Stations = {
            "Recto": [257.00, 233.00],
            "Legarda": [356.00, 233.00],
            "Pureza": [450.00, 233.00],
            "V. Mapa": [550.00, 233.00],
            "J. Ruiz": [645.00, 233.00],
            "Gilmore": [745.00, 233.00],
            "Betty Go-Belmonte": [845.00, 233.00],
            "Cubao": [942.00, 233.00],
            "Anonas": [1037.00, 233.00],
            "Katipunan": [1135.00, 233.00],
            "Santolan": [1235.00, 233.00],
            "Antipolo": [1330.00, 233.00],
        };
        const lrt1Stations = {
            "Roosevelt": [356.00, 130.00],
            "Balintawak": [256.00, 130.00],
            "Monumento": [160.00, 130.00],
            "5th Avenue": [160.00, 145.00],
            "R. Papa": [160.00, 160.00],
            "Abad Santos": [160.00, 175.00],
            "Blumentritt": [160.00, 190.00],
            "Tayuman": [160.00, 205.00],
            "Bambang": [160.00, 220.00],
            "Doroteo Jose": [160.00, 235.00],
            "Carriedo": [160.00, 250.00],
            "Central Terminal": [160.00, 265.00],
            "United Nations (UN)": [160.00, 280.00],
            "Pedro Gil": [160.00, 295.00],
            "Quirino": [160.00, 310.00],
            "Vito Cruz": [160.00, 325.00],
            "Gil Puyat": [160.00, 340.00],
            "Libertad": [160.00, 355.00],
            "EDSA": [160.00, 370.00],
            "Baclaran": [160.00, 385.00],
        };

        const mrt3Stations = {
            "North Avenue": [747.00, 145.00],
            "Quezon Avenue": [990.00, 173.00],
            "GMA Kamuning": [990.00, 203.00],
            "Araneta Center-Cubao": [990.00, 226.00],
            "Santolan-Annapolis": [990.00, 264.00],
            "Ortigas": [990.00, 293.00],
            "Shaw Boulevard": [940.00, 307.00],
            "Boni": [746.00, 323.00],
            "Guadalupe": [648.00, 338.00],
            "Buendia": [550.00, 367.00],
            "Ayala": [453.00, 368.00],
            "Magallanes": [356.00, 367.00],
            "Taft Avenue": [256.00, 367.00],
        };

        const threshold = 10; // Allowable distance from the exact coordinates
        const fromInput = document.getElementById('from-station');
        const toInput = document.getElementById('to-station');
        const outputContainer = document.getElementById('output-container');

        let clickCount = 0;

        document.getElementById('rail-map').addEventListener('load', () => {
            const iframe = document.getElementById('rail-map');
            const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;

            // Listen for clicks inside the iframe
            iframeDocument.addEventListener('click', (event) => {
                const rect = iframe.getBoundingClientRect();

                const clickX = event.clientX - rect.left;
                const clickY = event.clientY - rect.top;

                console.log(`Adjusted Click: (${clickX.toFixed(2)}, ${clickY.toFixed(2)})`);

                // Find nearest station in LRT1 or MRT3
                const station = getNearestStation(clickX, clickY);
                if (station) {
                    clickCount++;
                    if (clickCount === 1) {
                        fromInput.value = station;
                    } else if (clickCount === 2) {
                        toInput.value = station;
                        clickCount = 0; // Reset after selecting "From" and "To"
                    }
                } else {
                    console.log("No station near the clicked location.");
                }
            });
        });

        // Find the nearest station within the threshold
        function getNearestStation(clickX, clickY) {
            const allStations = { ...lrt1Stations, ...mrt3Stations,...lrt2Stations }; // Combine LRT1 and MRT3
            for (const [station, [stationX, stationY]] of Object.entries(allStations)) {
                const distanceX = Math.abs(stationX - clickX);
                const distanceY = Math.abs(stationY - clickY);
                if (distanceX <= threshold && distanceY <= threshold) {
                    return station;
                }
            }
            return null;
        }

        // Handle Submit Button
        document.getElementById('submit-button').addEventListener('click', () => {
            const fromStation = fromInput.value;
            const toStation = toInput.value;

            if (fromStation && toStation) {
                const message = `From: ${fromStation}, To: ${toStation}`;
                console.log(message);
                const display = document.createElement('p');
                display.textContent = message;
                outputContainer.appendChild(display);
            } else {
                alert('Please select both a "From" and "To" station.');
            }
        });

        // Handle Reset Button
        document.getElementById('reset-button').addEventListener('click', () => {
            fromInput.value = '';
            toInput.value = '';
            clickCount = 0;
            console.log('Inputs reset.');
        });
    </script>
</body>
</html>